---
import Layout from '../layouts/Layout.astro';
import Card from '../components/Card.astro';

export async function fetchContent({ request, response }) {
  if (request.method === 'POST') {
    try {
      const data = await request.formData();
      const name = data.get('name') as string;
      const email = data.get('email') as string;
      const topic = data.get('topic') as string;
      const summary = data.get('summary') as string;

      // Check if name has at least 6 characters
      if (name && name.length < 6) {
        throw new Error('Name must be at least 6 characters long');
      }

      // Check if email is valid (you can add more complex validation)
      if (email && !isValidEmail(email)) {
        throw new Error('Invalid email address');
      }

      // Check if topic and summary have at least 6 characters
      if ((topic && topic.length < 6) || (summary && summary.length < 6)) {
        throw new Error('Topic and summary must be at least 6 characters long');
      }

      // Retrieve all selected values for checkboxes
      const proposalTypes = data.getAll('proposal-type');

      // This is POST request, so it's not going to be visible in the browser.
      // Check Network tab in Inspect Mode of Google Chrome or Firefox to see the request.
      console.log('Name:', name);
      console.log('Email:', email);
      console.log('Topic:', topic);
      console.log('Summary:', summary);
      console.log('Proposal Types:', proposalTypes);
    } catch (error) {
      if (error instanceof Error) {
        console.error(error.message);
        // Handle the error message, you can display it to the user
      }
    }
  }
}

// Add a simple email validation function
function isValidEmail(email: string | null): boolean {
  // For simplicity, just check if it contains '@'
  return !!email && email.includes('@');
}
---

<Layout title="propose">
  <main>
    <h1>Propose an idea!</h1>
    <h2 class="text-2xl">Have an idea?! Submit it!</h2>
    <h3 class="text-xl">Fill out the form below!</h3>
    <form method="POST" id="proposalForm">
      <label for="name" class="text-l font-semibold">Name:</label>
      <input type="text" name="name" required minlength={6} />
      <label for="email" class="text-l font-semibold">Email:</label>
      <input type="email" name="email" />
      <label for="topic" class="text-l font-semibold">Topic:</label>
      <textarea
        id="topic"
        name="topic"
        required
        minlength={6}
        class="rounded-sm w-full"></textarea>
      <label for="summary" class="text-l font-semibold">Summary:</label>
      <textarea
        id="summary"
        name="summary"
        required
        minlength={6}
        rows={5}
        class="rounded-sm w-full"></textarea>
      <div
        class="checkboxes border-t-4 border-b-4 flex items-center justify-start text-left mb-4 gap-5"
      >
        <input
          type="checkbox"
          id="project"
          name="proposal-type"
          value="project"
        />
        <label for="project" class="text-l font-semibold">
          {' '}
          Project!{' '}
        </label>
        <br />
        <input type="checkbox" id="talk" name="proposal-type" value="talk" />
        <label for="talk" class="text-l font-semibold">
          {' '}
          Talk!{' '}
        </label>
        <br />
        <input type="checkbox" id="lab" name="proposal-type" value="lab" />
        <label for="lab" class="text-l font-semibold">
          {' '}
          Lab!
        </label>
        <br />
      </div>
      <button type="submit" class="bg-black text-white uppercase px-3 py-7">
        Submit
      </button>
    </form>
    <nav class="grid grid-cols-1 md:grid-cols-2 gap-2">
      <div class="md:col-span-2">
        <h2 class="text-2xl">What else can I do?</h2>
        <Card
          title="Vote on Topics and Projects"
          href="/vote"
          body="We want input from you on what we program!"
        />
        <Card
          title="Go Back!"
          href="/home"
          body="Return to the home page to see what we're all about!"
        />
      </div>
    </nav>
  </main>
</Layout>
